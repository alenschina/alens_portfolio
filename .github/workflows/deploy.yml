name: Deploy to Tencent Server

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Build application
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }}
          COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
          COS_BUCKET: ${{ secrets.COS_BUCKET }}
          COS_REGION: ${{ secrets.COS_REGION }}
          COS_BASE_URL: ${{ secrets.COS_BASE_URL }}

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || '/var/www/alens-portfolio' }}
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°æœåŠ¡å™¨..."

          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          ssh $SSH_USER@$SSH_HOST "mkdir -p $DEPLOY_PATH"

          # åŒæ­¥æ„å»ºæ–‡ä»¶åˆ°æœåŠ¡å™¨
          echo "ğŸ“¦ åŒæ­¥æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='prisma/dev.db' \
            ./ $SSH_USER@$SSH_HOST:$DEPLOY_PATH/

          # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²å‘½ä»¤
          echo "ğŸ”§ åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²..."
          ssh $SSH_USER@$SSH_HOST << EOF
            cd $DEPLOY_PATH

            # å®‰è£…ç”Ÿäº§ä¾èµ–
            echo "ğŸ“¥ å®‰è£…ä¾èµ–..."
            npm ci --production

            # ç”Ÿæˆ Prisma Client
            echo "ğŸ—„ï¸ ç”Ÿæˆ Prisma Client..."
            npx prisma generate

            # æ‰§è¡Œæ•°æ®åº“è¿ç§»
            echo "ğŸ”„ æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
            npx prisma migrate deploy

            # åˆ›å»ºæˆ–æ›´æ–°ç¯å¢ƒå˜é‡æ–‡ä»¶
            echo "âš™ï¸ æ›´æ–°ç¯å¢ƒå˜é‡..."
            cat > .env << EOL
          DATABASE_URL="${{ secrets.DATABASE_URL }}"
          NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}"
          NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}"
          COS_SECRET_ID="${{ secrets.COS_SECRET_ID }}"
          COS_SECRET_KEY="${{ secrets.COS_SECRET_KEY }}"
          COS_BUCKET="${{ secrets.COS_BUCKET }}"
          COS_REGION="${{ secrets.COS_REGION }}"
          COS_BASE_URL="${{ secrets.COS_BASE_URL }}"
          EOL

            # ä½¿ç”¨ PM2 é‡å¯åº”ç”¨
            echo "ğŸ”„ é‡å¯åº”ç”¨..."
            if pm2 list | grep -q "alens-portfolio"; then
              pm2 reload alens-portfolio --update-env
            else
              pm2 start npm --name "alens-portfolio" -- start
              pm2 save
            fi

            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          EOF

      - name: Notify deployment success
        if: success()
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "åº”ç”¨åœ°å€: ${{ secrets.NEXTAUTH_URL }}"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
